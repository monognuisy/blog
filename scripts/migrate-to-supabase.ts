import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { createClient } from '@supabase/supabase-js';
import { config } from 'dotenv';
import { Posts } from '@/types/supabase';
import { Database } from '@/types/supabase';

type PostWithoutAutoGeneratedFields = Omit<Posts, 'created_at' | 'updated_at' | 'id'>;

// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
config({ path: '.env.local' });

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);

const postsDirectory = path.join(process.cwd(), 'content/blog');


// MDX íŒŒì¼ì—ì„œ ë°ì´í„° ì¶”ì¶œ
function parsePost(filePath: string, category: string): PostWithoutAutoGeneratedFields {
  const fileContents = fs.readFileSync(filePath, 'utf8');
  const { data: frontmatter } = matter(fileContents);
  
  const fileName = path.basename(filePath, '.mdx');

  const slug = `${category}/${fileName}`;
  
  return {
    slug: slug,
    title: frontmatter.title,
    description: frontmatter.description || null,
    category: category,
    tags: frontmatter.tags || [],
    cover: frontmatter.cover || null,
    date: frontmatter.date,
    published: true
  };
}

// ëª¨ë“  ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìˆ˜ì§‘
function getAllPosts(): PostWithoutAutoGeneratedFields[] {
  const posts: PostWithoutAutoGeneratedFields[] = [];
  
  // ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì²˜ë¦¬
  const categories = fs.readdirSync(postsDirectory);
  
  for (const category of categories) {
    const categoryPath = path.join(postsDirectory, category);
    
    if (fs.statSync(categoryPath).isDirectory()) {
      const files = fs.readdirSync(categoryPath);
      
      for (const file of files) {
        if (file.endsWith('.mdx')) {
          const filePath = path.join(categoryPath, file);
          const post = parsePost(filePath, category);
          posts.push(post);
        }
      }
    }
  }
  
  return posts;
}

// Supabaseì— ë°ì´í„° ì‚½ì…
async function insertPosts(posts: PostWithoutAutoGeneratedFields[]) {
  console.log(`ğŸš€ ${posts.length}ê°œì˜ í¬ìŠ¤íŠ¸ë¥¼ Supabaseì— ì‚½ì… ì¤‘...`);
  
  // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì „ì²´ ì‚­ì œ)
  const { error: deleteError } = await supabase
    .from('posts')
    .delete()
    .gte('created_at', '1900-01-01'); // ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œ
  
  if (deleteError) {
    console.error('âŒ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', deleteError);
    return;
  }
  
  // ìƒˆ ë°ì´í„° ì‚½ì…
  const { data, error } = await supabase
    .from('posts')
    .insert(posts);
  
  if (error) {
    console.error('âŒ ë°ì´í„° ì‚½ì… ì‹¤íŒ¨:', error);
    return;
  }
  
  console.log('âœ… í¬ìŠ¤íŠ¸ ì‚½ì… ì™„ë£Œ!');
  console.log(`ğŸ“Š ì´ ${posts.length}ê°œì˜ í¬ìŠ¤íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ë©”ì¸ í•¨ìˆ˜
async function main() {
  try {
    console.log('ğŸ“– MDX íŒŒì¼ íŒŒì‹± ì¤‘...');
    const posts = getAllPosts();
    
    console.log(`ğŸ“ ${posts.length}ê°œì˜ í¬ìŠ¤íŠ¸ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:`);
    posts.forEach((post, index) => {
      console.log(`  ${index + 1}. [${post.category}] ${post.title}`);
    });
    
    await insertPosts(posts);
    
    console.log('ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (error) {
    console.error('ğŸ’¥ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
  }
}

main(); 
